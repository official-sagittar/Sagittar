#pragma once

#include "commons/pch.h"
#include "core/position.h"
#include "core/types.h"

namespace sagittar::eval::hce {

    enum GamePhase : u8 {
        MG,
        EG
    };

    constexpr std::array<i32, 7> PHASE_WEIGHTS = {0, 0, 1, 1, 2, 4, 0};
    constexpr i32                TOTAL_PHASE   = 24;

    constexpr i32 S(const i32 mg, const i32 eg) {
        return static_cast<i32>(static_cast<u32>(eg) << 16) + mg;
    }
    constexpr i32 mg_score(const i32 score) { return static_cast<i16>(score); }
    constexpr i32 eg_score(const i32 score) { return static_cast<i16>((score + 0x8000) >> 16); }

    constexpr Score scale_eval(const Score mg, const Score eg, const i32 phase) {
        return static_cast<Score>(((mg * (256 - phase)) + (eg * phase)) / 256);
    }

    constexpr i32 std_phase(const i32 phase) {
        return ((phase * 256 + (TOTAL_PHASE / 2)) / TOTAL_PHASE);
    }

    inline i32 pos_phase(const Position& pos) {
        i32 phase = TOTAL_PHASE;

        for (int pt = PieceType::PAWN; pt <= PieceType::KING; pt++)
        {
            phase -= pos.pieceCount(static_cast<PieceType>(pt)) * PHASE_WEIGHTS[pt];
        }

        phase = std_phase(phase);

        return phase;
    }

    // https://www.chessprogramming.org/PeSTO%27s_Evaluation_Function
    // clang-format off
    constexpr std::array<i32, 7> PIECE_SCORES = {
        0,
        S(116, 149),    // PAWN
        S(226, 252),    // KNIGHT
        S(241, 280),    // BISHOP
        S(372, 475),    // ROOK
        S(922, 834),    // QUEEN
        0               // KING
    };

    using PSQT = std::array<i32, 64>;

    constexpr std::array<PSQT, 7> PSQT_SCORES = []() {
        std::array<PSQT, 7> table{};

        table[PieceType::PIECE_TYPE_INVALID] = {};

        table[PieceType::PAWN] = {
            S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),
            S(118, 115),    S(99, 114),     S(2, 117),      S(132, 114),    S(15, 113),     S(136, 100),    S(25, 137),     S(33, 16),
            S(-33, 51),     S(41, 23),      S(-56, 44),     S(17, 33),      S(14, 4),       S(-5, 3),       S(57, 39),      S(-4, 14),
            S(-23, 6),      S(-8, -24),     S(-24, -6),     S(25, -74),     S(30, -44),     S(18, -41),     S(-45, -14),    S(-29, -38),
            S(-41, -36),    S(3, -12),      S(-28, -37),    S(-8, -44),     S(-14, -34),    S(-3, -44),     S(-20, -45),    S(-41, -28),
            S(-39, -19),    S(-1, -26),     S(-37, -33),    S(-26, -72),    S(-14, -38),    S(-35, -45),    S(-1, -35),     S(-20, -35),
            S(-55, -8),     S(1, -20),      S(-39, -37),    S(-35, -65),    S(-71, -3),     S(-7, -24),     S(29, -31),     S(-31, -32),
            S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),
        };

        table[PieceType::KNIGHT] = {
            S(-62, 20),     S(-46, -12),    S(-58, -34),    S(5, 51),       S(38, -2),      S(-142, -36),   S(-16, -103),   S(-162, -90),
            S(4, 48),       S(-53, -16),    S(19, 42),      S(-30, 38),     S(85, 66),      S(148, 32),     S(-56, -21),    S(79, 11),
            S(47, -8),      S(44, 13),      S(111, 69),     S(92, 54),      S(92, 22),      S(223, 53),     S(25, 11),      S(11, 33),
            S(27, 48),      S(-9, -26),     S(34, -27),     S(53, 61),      S(21, 50),      S(3, 74),       S(45, 1),       S(22, 27),
            S(-36, -50),    S(101, -69),    S(-2, 73),      S(-2, 57),      S(-3, 17),      S(-14, 31),     S(-1, 78),      S(-27, 31),
            S(-84, -43),    S(-59, 58),     S(-22, 14),     S(55, 11),      S(-3, 16),      S(10, 9),       S(-3, 30),      S(-31, -41),
            S(-82, -107),   S(-83, 13),     S(0, 28),       S(-20, -59),    S(-12, -28),    S(-22, -9),     S(-55, 24),     S(30, -122),
            S(-74, -82),    S(-35, -114),   S(9, -94),      S(-75, -51),    S(-76, 1),      S(-25, -17),    S(-35, -66),    S(81, 11),
        };

        table[PieceType::BISHOP] = {
            S(9, -12),      S(-63, -12),    S(-10, 37),     S(-126, -4),    S(-66, -22),    S(-129, 20),    S(65, -22),     S(-68, -15),
            S(-17, 35),     S(-54, 31),     S(34, -16),     S(-13, -27),    S(97, -13),     S(30, -21),     S(-51, -14),    S(-8, -64),
            S(41, -5),      S(-42, 52),     S(-19, 30),     S(46, 33),      S(-30, 31),     S(-24, 28),     S(-9, 45),      S(3, 12),
            S(59, -76),     S(30, 22),      S(-34, 55),     S(33, -12),     S(59, 10),      S(8, 25),       S(42, 30),      S(64, 52),
            S(-8, -26),     S(80, 62),      S(-8, 42),      S(45, 34),      S(27, 18),      S(20, 18),      S(11, 34),      S(51, 2),
            S(-12, 40),     S(69, -20),     S(-16, 32),     S(17, -2),      S(27, 36),      S(21, -3),      S(7, 52),       S(-13, 20),
            S(-6, -57),     S(22, -30),     S(7, -28),      S(17, 22),      S(20, -14),     S(-29, -44),    S(41, -6),      S(-54, -54),
            S(42, -45),     S(13, -81),     S(-9, -20),     S(-94, 1),      S(-56, 7),      S(10, -80),     S(-112, -60),   S(13, -60),
        };

        table[PieceType::ROOK] = {
            S(78, 16),      S(85, -17),     S(60, 46),      S(-28, 12),     S(-37, 63),     S(-25, 26),     S(89, -4),      S(78, 26),
            S(-77, 56),     S(74, -4),      S(103, 19),     S(17, 63),      S(124, -7),     S(85, 23),      S(67, 41),      S(112, -22),
            S(-28, 50),     S(-45, 33),     S(-9, 12),      S(19, 37),      S(21, 17),      S(80, 32),      S(100, 11),     S(65, 5),
            S(-52, 37),     S(35, 9),       S(60, 39),      S(12, 60),      S(51, 31),      S(-15, 46),     S(-25, 29),     S(-2, 27),
            S(-37, 8),      S(-88, -7),     S(-38, -7),     S(-33, 44),     S(-58, 12),     S(-14, -14),    S(43, -50),     S(-47, 41),
            S(4, 5),        S(47, -87),     S(7, -29),      S(-3, -9),      S(-74, -24),    S(-12, -47),    S(-44, -27),    S(-116, 57),
            S(-103, -49),   S(-36, -31),    S(-108, -53),   S(-22, -41),    S(2, -86),      S(-41, -21),    S(12, -84),     S(-148, -14),
            S(-35, -62),    S(-14, -36),    S(-38, -5),     S(-21, -25),    S(-5, -22),     S(-19, -42),    S(20, -48),     S(-55, -63),
        };

        table[PieceType::QUEEN] = {
            S(41, 39),      S(29, 46),      S(105, -10),    S(60, 33),      S(-19, -12),    S(94, -2),      S(-30, 40),     S(84, 44),
            S(-39, 10),     S(-48, -40),    S(58, 85),      S(43, 37),      S(-50, 115),    S(41, -39),     S(12, 84),      S(-43, 25),
            S(31, 30),      S(14, 48),      S(0, 8),        S(-38, 110),    S(45, 91),      S(-16, 90),     S(-28, 63),     S(117, 19),
            S(-45, 56),     S(-33, 69),     S(-40, 12),     S(-25, 48),     S(-50, 124),    S(-52, -11),    S(37, 102),     S(51, 17),
            S(16, 4),       S(47, 79),      S(-9, 62),      S(46, 34),      S(24, 85),      S(13, -26),     S(-59, 37),     S(-41, -35),
            S(-1, -36),     S(4, -84),      S(-9, 25),      S(26, 20),      S(-33, 30),     S(-7, -15),     S(22, -83),     S(-64, -40),
            S(-29, -105),   S(16, -53),     S(6, -71),      S(13, -98),     S(17, -93),     S(-57, -93),    S(8, -124),     S(-7, -106),
            S(-57, -63),    S(-90, -57),    S(-16, -109),   S(11, -117),    S(39, -87),     S(40, -104),    S(-62, -74),    S(-112, -33),
        };

        table[PieceType::KING] = {
            S(-59, -130),   S(75, 15),      S(46, -47),     S(23, -26),     S(-8, 2),       S(26, 82),      S(79, 67),      S(13, -89),
            S(101, 53),     S(36, 0),       S(35, 55),      S(22, 0),       S(66, 33),      S(-37, 42),     S(34, 66),      S(29, 32),
            S(54, -14),     S(85, 49),      S(-27, 51),     S(30, 15),      S(-32, 19),     S(-39, 40),     S(-39, 37),     S(28, 59),
            S(30, -20),     S(52, 45),      S(-42, 29),     S(-19, 12),     S(-58, 29),     S(-63, 32),     S(-10, 39),     S(10, -18),
            S(-94, -40),    S(61, 16),      S(65, -7),      S(-77, 15),     S(38, -7),      S(-1, 8),       S(23, 17),      S(-82, 6),
            S(-25, 47),     S(82, -4),      S(-85, 13),     S(-52, 11),     S(-98, 17),     S(4, -17),      S(-74, -5),     S(-25, -45),
            S(-50, -27),    S(-19, 3),      S(49, -11),     S(-34, -27),    S(-98, 15),     S(-27, -41),    S(46, -28),     S(53, -79),
            S(-70, 22),     S(17, -41),     S(31, -56),     S(-41, -74),    S(27, -67),     S(-92, -5),     S(83, -80),     S(24, -88),
        };

        return table;
    }();
    // clang-format on

    constexpr i32 TEMPO_BONUS = S(15, 3);
}
