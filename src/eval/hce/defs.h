#pragma once

#include "commons/pch.h"
#include "core/types.h"

namespace sagittar::eval::hce {

    enum GamePhase : u8 {
        MG,
        EG
    };

    constexpr std::array<i32, 7> PHASE_WEIGHTS = {0, 0, 1, 1, 2, 4, 0};
    constexpr i32                TOTAL_PHASE   = 24;

    constexpr i32 S(const i32 mg, const i32 eg) {
        return static_cast<i32>(static_cast<u32>(eg) << 16) + mg;
    }
    constexpr i32 mg_score(const i32 score) { return static_cast<i16>(score); }
    constexpr i32 eg_score(const i32 score) { return static_cast<i16>((score + 0x8000) >> 16); }

    constexpr Score scale_eval(const Score mg, const Score eg, const i32 phase) {
        return static_cast<Score>(((mg * (256 - phase)) + (eg * phase)) / 256);
    }

    constexpr i32 std_phase(const i32 phase) {
        return ((phase * 256 + (TOTAL_PHASE / 2)) / TOTAL_PHASE);
    }

    inline i32 pos_phase(const Position& pos) {
        i32 phase = TOTAL_PHASE;

        for (int pt = PieceType::PAWN; pt <= PieceType::KING; pt++)
        {
            phase -= pos.pieceCount(static_cast<PieceType>(pt)) * PHASE_WEIGHTS[pt];
        }

        phase = std_phase(phase);

        return phase;
    }

    // https://www.chessprogramming.org/PeSTO%27s_Evaluation_Function
    // clang-format off
    constexpr std::array<i32, 7> PIECE_SCORES = {
        0,
        S(84, 121),     // PAWN
        S(224, 304),    // KNIGHT
        S(239, 314),    // BISHOP
        S(360, 516),    // ROOK
        S(967, 897),    // QUEEN
        0               // KING
    };

    using PSQT = std::array<i32, 64>;

    constexpr std::array<PSQT, 7> PSQT_SCORES = []() {
        std::array<PSQT, 7> table{};

        table[PieceType::PIECE_TYPE_INVALID] = {};

        table[PieceType::PAWN] = {
            S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),
            S(161, 169),    S(129, 171),    S(15, 187),     S(166, 197),    S(7, 184),      S(162, 182),    S(32, 217),     S(65, 101),
            S(-17, 112),    S(72, 71),      S(-32, 96),     S(31, 99),      S(39, 50),      S(19, 58),      S(97, 87),      S(13, 66),
            S(-13, 73),     S(11, 31),      S(-10, 64),     S(47, -25),     S(50, 12),      S(37, 11),      S(-26, 38),     S(-15, 17),
            S(-26, 18),     S(19, 54),      S(-9, 16),      S(11, 9),       S(6, 21),       S(13, 12),      S(-1, 5),       S(-28, 31),
            S(-27, 45),     S(17, 29),      S(-20, 25),     S(-5, -25),     S(7, 15),       S(-18, 6),      S(19, 16),      S(-7, 25),
            S(-43, 60),     S(18, 42),      S(-20, 17),     S(-14, -9),     S(-51, 62),     S(9, 38),       S(49, 23),      S(-19, 30),
            S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),        S(0, 0),
        };

        table[PieceType::KNIGHT] = {
            S(-85, 16),     S(-66, -22),    S(-80, -48),    S(-18, 44),     S(14, -21),     S(-165, -38),   S(-35, -105),   S(-183, -114),
            S(-17, 43),     S(-66, -32),    S(4, 35),       S(-52, 34),     S(65, 58),      S(126, 25),     S(-77, -40),    S(59, 3),
            S(29, -25),     S(40, -5),      S(97, 61),      S(79, 48),      S(86, 6),       S(202, 49),     S(11, -3),      S(-12, 25),
            S(14, 38),      S(-17, -41),    S(26, -42),     S(44, 52),      S(14, 36),      S(-17, 72),     S(36, -15),     S(13, 19),
            S(-46, -66),    S(82, -76),     S(-13, 65),     S(-10, 46),     S(-13, 7),      S(-25, 24),     S(-9, 70),      S(-36, 22),
            S(-103, -47),   S(-74, 53),     S(-33, 7),      S(47, -3),      S(-15, 9),      S(1, -1),       S(-14, 25),     S(-40, -54),
            S(-97, -112),   S(-101, 13),    S(-10, 12),     S(-31, -66),    S(-23, -35),    S(-36, -16),    S(-76, 33),     S(19, -129),
            S(-94, -88),    S(-46, -120),   S(1, -102),     S(-94, -60),    S(-95, -14),    S(-40, -15),    S(-46, -72),    S(61, 9),
        };

        table[PieceType::BISHOP] = {
            S(16, -12),     S(-59, -19),    S(-5, 44),      S(-120, -9),    S(-56, -25),    S(-123, 22),    S(71, -27),     S(-61, -26),
            S(-9, 27),      S(-50, 33),     S(35, -16),     S(-10, -28),    S(102, -14),    S(27, -27),     S(-49, -9),     S(-5, -68),
            S(45, 1),       S(-37, 50),     S(-22, 36),     S(39, 41),      S(-29, 32),     S(-22, 29),     S(-10, 48),     S(-3, 20),
            S(58, -78),     S(27, 24),      S(-38, 62),     S(32, -13),     S(57, 13),      S(3, 30),       S(38, 36),      S(67, 53),
            S(-12, -22),    S(84, 67),      S(-13, 49),     S(40, 39),      S(25, 23),      S(15, 23),      S(9, 38),       S(47, 9),
            S(-19, 49),     S(67, -17),     S(-22, 40),     S(12, 2),       S(22, 41),      S(17, 3),       S(3, 55),       S(-20, 31),
            S(-13, -47),    S(17, -25),     S(2, -24),      S(13, 26),      S(16, -10),     S(-31, -43),    S(36, 1),       S(-58, -52),
            S(46, -45),     S(11, -81),     S(-13, -17),    S(-91, -2),     S(-58, 10),     S(7, -80),      S(-108, -70),   S(13, -57),
        };

        table[PieceType::ROOK] = {
            S(91, 31),      S(104, -4),     S(76, 63),      S(-19, 35),     S(-21, 83),     S(-13, 42),     S(102, 13),     S(95, 36),
            S(-60, 67),     S(92, 4),       S(119, 33),     S(46, 73),      S(138, 7),      S(102, 36),     S(86, 53),      S(129, -12),
            S(-17, 62),     S(-29, 42),     S(7, 20),       S(37, 49),      S(39, 27),      S(99, 45),      S(120, 21),     S(85, 13),
            S(-41, 48),     S(54, 12),      S(77, 51),      S(24, 72),      S(70, 44),      S(-2, 59),      S(-21, 37),     S(15, 35),
            S(-24, 19),     S(-67, -1),     S(-28, 8),      S(-18, 57),     S(-42, 20),     S(-1, -5),      S(64, -49),     S(-34, 53),
            S(19, 19),      S(61, -79),     S(19, -16),     S(17, -3),      S(-58, -15),    S(5, -42),      S(-32, -14),    S(-101, 69),
            S(-88, -37),    S(-24, -13),    S(-92, -44),    S(-7, -31),     S(19, -77),     S(-27, -5),     S(29, -76),     S(-134, 2),
            S(-20, -50),    S(-2, -19),     S(-25, 11),     S(-8, -7),      S(10, -8),      S(-5, -28),     S(33, -33),     S(-39, -54),
        };

        table[PieceType::QUEEN] = {
            S(47, 56),      S(37, 68),      S(109, 9),      S(68, 47),      S(-14, 2),      S(99, 10),      S(-25, 63),     S(95, 63),
            S(-30, 22),     S(-38, -32),    S(66, 99),      S(43, 58),      S(-45, 127),    S(45, -28),     S(16, 100),     S(-36, 37),
            S(41, 43),      S(22, 63),      S(5, 21),       S(-34, 124),    S(54, 106),     S(-8, 103),     S(-20, 73),     S(123, 38),
            S(-39, 68),     S(-25, 82),     S(-35, 27),     S(-19, 67),     S(-43, 138),    S(-47, 1),      S(45, 115),     S(57, 34),
            S(22, 14),      S(54, 95),      S(-1, 75),      S(52, 45),      S(30, 99),      S(18, -12),     S(-51, 46),     S(-36, -20),
            S(2, -13),      S(10, -73),     S(-6, 46),      S(32, 36),      S(-29, 48),     S(-3, 3),       S(28, -72),     S(-61, -24),
            S(-25, -92),    S(20, -34),     S(10, -59),     S(18, -88),     S(22, -79),     S(-52, -82),    S(14, -113),    S(-4, -92),
            S(-52, -54),    S(-87, -46),    S(-12, -95),    S(16, -106),    S(42, -71),     S(49, -97),     S(-56, -58),    S(-107, -17),
        };

        table[PieceType::KING] = {
            S(-77, -120),   S(53, 28),      S(43, -54),     S(9, -4),       S(-26, 16),     S(4, 93),       S(58, 76),      S(-16, -85),
            S(83, 65),      S(24, 7),       S(16, 73),      S(27, 7),       S(50, 47),      S(-49, 48),     S(18, 79),      S(11, 40),
            S(40, -10),     S(69, 63),      S(-38, 64),     S(21, 26),      S(-51, 25),     S(-51, 50),     S(-51, 41),     S(14, 73),
            S(15, -12),     S(38, 55),      S(-56, 40),     S(-30, 24),     S(-73, 43),     S(-75, 42),     S(-24, 49),     S(4, -17),
            S(-114, -36),   S(45, 32),      S(46, 7),       S(-94, 29),     S(14, 8),       S(-17, 22),     S(6, 30),       S(-96, 15),
            S(-39, 59),     S(63, 9),       S(-105, 29),    S(-71, 24),     S(-122, 33),    S(-18, -3),     S(-94, 7),      S(-45, -36),
            S(-70, -13),    S(-41, 23),     S(23, 8),       S(-55, -15),    S(-119, 30),    S(-48, -29),    S(29, -18),     S(36, -72),
            S(-89, 30),     S(-2, -32),     S(11, -44),     S(-61, -65),    S(8, -56),      S(-110, 4),     S(67, -76),     S(6, -82),
        };

        return table;
    }();
    // clang-format on

    constexpr i32 TEMPO_BONUS = S(15, 3);
}
